on: push
env:
  BASE_IMAGE_NAME: registry.mpardo.me/docker-registry-explorer
  BRANCH_IMAGE_NAME: $BASE_IMAGE_NAME:${{ github.ref_name }}
  COMMIT_IMAGE_NAME: $BASE_IMAGE_NAME:${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ vars.RUST_VERSION }}
      - run: cargo build --release
      - name: Docker login
        run: echo $REGISTRY_PASSWORD | docker login -u github $REGISTRY_HOST --password-stdin
        shell: bash
        env:
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_HOST: ${{ vars.REGISTRY_HOST }}
      - run: docker build . -t ${{ env.COMMIT_IMAGE_NAME }} -t ${{ env.BRANCH_IMAGE_NAME }}
      - run: docker push ${{ env.COMMIT_IMAGE_NAME }}
      - run: docker push ${{ env.BRANCH_IMAGE_NAME }}
